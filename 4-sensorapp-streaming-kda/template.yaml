AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: SensorData - KDA example

# This template builds the Kinesis stream ARN from the base
# template using the following expression:
#   !Sub "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/sensordata"

Parameters:
  IoTdataEndpoint:
    Type: String
    Default: "abc123abc123-ats.iot.us-east-2.amazonaws.com"

Resources:
  ##########################################
  # Kinesis Data Analytics configuration   #
  ##########################################
  KinesisAnalyticsSensorApplication:
    Type: "AWS::KinesisAnalytics::Application"
    Properties:
      ApplicationName: "sensor-stats"
      ApplicationCode: |
        -- -- 1. Calculate output field 
        CREATE OR REPLACE STREAM "SENSORCALC_STREAM" (
            "event" VARCHAR(8),
            "deviceTimestamp" BIGINT,
            "COL_second" INTEGER, 
            "name" VARCHAR(16),              
            "facilityId" INTEGER,
            "processId" BIGINT,
            "sensorId" INTEGER NOT NULL, 
            "min_value" REAL,
            "max_value" REAL,
            "stddev_value" REAL);
            
        CREATE OR REPLACE PUMP "SENSORCALC_STREAM_PUMP" AS 
        INSERT INTO "SENSORCALC_STREAM" 
        SELECT STREAM 
            "event",            
            "deviceTimestamp",
            "COL_second",            
            "name", 
            "facilityId",             
            "processId",             
            "sensorId",
            MIN("sensorData") OVER SIXTY_SECOND_SLIDING_WINDOW AS "min_value",
            MAX("sensorData") OVER SIXTY_SECOND_SLIDING_WINDOW AS "max_value",
            STDDEV_SAMP("sensorData") OVER SIXTY_SECOND_SLIDING_WINDOW AS "stddev_value"
            
        FROM "SOURCE_SQL_STREAM_001"
        WINDOW SIXTY_SECOND_SLIDING_WINDOW AS (
          PARTITION BY "processId","sensorId"
          RANGE INTERVAL '60' SECOND PRECEDING);

      Inputs:
        - NamePrefix: "SOURCE_SQL_STREAM"
          InputParallelism:
            Count: 1
          InputSchema:
            RecordFormat:
              RecordFormatType: "JSON"
              MappingParameters:
                JSONMappingParameters:
                  RecordRowPath: "$"
            RecordEncoding: "UTF-8"
            RecordColumns:
              - Name: "uuid"
                Mapping: "$.uuid"
                SqlType: "VARCHAR(64)"
              - Name: "event"
                Mapping: "$.event"
                SqlType: "VARCHAR(8)"
              - Name: "deviceTimestamp"
                Mapping: "$.deviceTimestamp"
                SqlType: "BIGINT"
              - Name: "COL_second"
                Mapping: "$.second"
                SqlType: "INTEGER"
              - Name: "name"
                Mapping: "$.name"
                SqlType: "VARCHAR(16)"
              - Name: "sensorId"
                Mapping: "$.sensorId"
                SqlType: "INTEGER"
              - Name: "processId"
                Mapping: "$.processId"
                SqlType: "BIGINT"
              - Name: "facilityId"
                Mapping: "$.facilityId"
                SqlType: "INTEGER"
              - Name: "sensorData"
                Mapping: "$.sensorData"
                SqlType: "REAL"
          KinesisStreamsInput:
            ResourceARN: !Sub "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/sensordata"
            RoleARN: !GetAtt KinesisAnalyticsSensorRole.Arn

  KinesisAnalyticsSensorApplicationOutput:
    Type: "AWS::KinesisAnalytics::ApplicationOutput"
    DependsOn: KinesisAnalyticsSensorApplication
    Properties:
      ApplicationName: !Ref KinesisAnalyticsSensorApplication
      Output:
        Name: "SENSORCALC_STREAM"
        LambdaOutput:
          ResourceARN: !GetAtt SensorStatsFunction.Arn
          RoleARN: !GetAtt KinesisAnalyticsSensorRole.Arn
        DestinationSchema:
          RecordFormatType: "JSON"

  ##########################################
  # Lambda function for KDA destination    #
  ##########################################
  SensorStatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SensorStatsFunction/
      Handler: app.handler
      Runtime: nodejs14.x
      MemorySize: 128
      Environment:
        Variables:
          IOT_DATA_ENDPOINT: !Ref IoTdataEndpoint
          TOPIC: "sensordata-subscribe"
      Policies:
        - Statement:
            - Sid: PublishToIotPolicy
              Effect: Allow
              Action:
                - "iot:Publish"
              Resource: "*"

  ###################################################################
  #  Kinesis Analytics Role for Sensor Data #
  ###################################################################
  KinesisAnalyticsSensorRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - kinesisanalytics.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Path: /
      Policies:
        - PolicyName: ReadInputSensorKinesis
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "kinesis:DescribeStream"
                  - "kinesis:GetShardIterator"
                  - "kinesis:GetRecords"
                Resource: !Sub "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/sensordata"
        - PolicyName: InvokeSensorStatsLambdaFunction
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "lambda:InvokeFunction"
                  - "lambda:GetFunctionConfiguration"
                Resource: !GetAtt SensorStatsFunction.Arn
